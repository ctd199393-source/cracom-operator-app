<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>body{padding:20px;}</style>
</head>
<body>
    <h3>ğŸ” è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰</h3>
    <div id="status" class="alert alert-info">åˆæœŸåŒ–ä¸­...</div>
    <div class="mb-3">
        <button onclick="window.location.reload()" class="btn btn-secondary">å†èª­ã¿è¾¼ã¿</button>
        <a href="/.auth/logout" class="btn btn-outline-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
    
    <h5>1. èªè¨¼æƒ…å ± (/.auth/me)</h5>
    <pre id="auth-debug" class="bg-light p-3 border">å–å¾—ä¸­...</pre>

    <h5>2. APIå¿œç­” (/api/show-env)</h5>
    <pre id="api-debug" class="bg-light p-3 border">å¾…æ©Ÿä¸­...</pre>

    <script>
        (async () => {
            const statusEl = document.getElementById('status');
            const authEl = document.getElementById('auth-debug');
            const apiEl = document.getElementById('api-debug');

            // 1. èªè¨¼ãƒã‚§ãƒƒã‚¯
            try {
                const authRes = await fetch('/.auth/me');
                const authData = await authRes.json();
                authEl.textContent = JSON.stringify(authData, null, 2);

                if (!authData.clientPrincipal) {
                    statusEl.className = 'alert alert-warning';
                    statusEl.innerHTML = 'æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚<a href="/.auth/login/aad">ã“ã“ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„ã€‚';
                    return;
                }
            } catch (e) {
                authEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            }

            // 2. APIãƒã‚§ãƒƒã‚¯
            try {
                statusEl.textContent = 'APIã«å•ã„åˆã‚ã›ä¸­...';
                const apiRes = await fetch('/api/show-env');
                
                const apiText = await apiRes.text(); // ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
                try {
                    // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
                    const apiJson = JSON.parse(apiText);
                    apiEl.textContent = JSON.stringify(apiJson, null, 2);
                } catch (e) {
                    // HTMLã‚¨ãƒ©ãƒ¼ãªã©ãŒè¿”ã£ã¦ãã¦ã„ã‚‹å ´åˆ
                    apiEl.textContent = "JSONã§ã¯ã‚ã‚Šã¾ã›ã‚“:\n" + apiText;
                }

                if (apiRes.ok) {
                    statusEl.className = 'alert alert-success';
                    statusEl.textContent = 'APIé€šä¿¡æˆåŠŸ (200 OK)';
                } else {
                    statusEl.className = 'alert alert-danger';
                    statusEl.textContent = `APIã‚¨ãƒ©ãƒ¼: ${apiRes.status} ${apiRes.statusText}`;
                }

            } catch (e) {
                statusEl.className = 'alert alert-danger';
                statusEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ';
                apiEl.textContent = e.toString();
            }
        })();
    </script>
</body>
</html>
