<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オペレーター指示書アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: "Helvetica Neue", Arial, sans-serif; padding-bottom: 100px; }
        
        /* ヘッダー */
        .app-header { background-color: #fff; border-bottom: 3px solid #cf2e2e; padding: 10px 15px; position: sticky; top: 0; z-index: 1000; }
        .company-name { font-weight: bold; color: #333; font-size: 1.1rem; }
        .greeting-bar { background-color: #fff; text-align: center; color: #0056b3; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #ddd; font-size: 1.2rem; }
        
        /* リスト画面カード */
        .today-card { border: 2px solid #0056b3; background: white; border-radius: 5px; margin: 15px 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s; }
        .today-card:active { transform: scale(0.98); background-color: #f8f9fa; }
        .today-body { padding: 15px; }
        .time-badge { font-size: 1.3rem; font-weight: bold; }
        .tag-badge { border: 1px solid #0056b3; color: #0056b3; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        
        /* 詳細画面 */
        .info-box { background: #fff; border: 2px solid #0056b3; border-radius: 5px; padding: 5px 10px; width: 100%; margin-bottom: 8px; }
        .info-label { color: #0056b3; font-size: 0.8rem; font-weight: bold; margin-bottom: 2px; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: #333; white-space: pre-wrap; }
        
        /* 詳細：上段ボックス */
        .detail-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .box-time { flex: 2; text-align: center; }
        .box-type { flex: 1; text-align: center; }
        .box-car { flex: 2; text-align: right; }
        .car-number { font-size: 1.3rem; color: #0056b3; font-weight: 900; }
        
        /* 詳細：特別なボックス */
        .box-contact { border-color: #8B4513; color: #8B4513; }
        .box-contact .info-label { color: #8B4513; }
        .box-notes { border-color: #0056b3; min-height: 100px; }
        .note-text { font-size: 1rem; line-height: 1.5; color: #333; white-space: pre-wrap; }

        /* ボタン類 */
        .btn-action-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-map { background: #e0e0e0; border: none; color: #333; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 12px; border-radius: 5px; }
        .btn-files { background: #e0e0e0; border: none; color: #0056b3; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 12px; border-radius: 5px; }
        
        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ccc; z-index: 2000; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .btn-back { background: #0056b3; color: white; font-weight: bold; flex: 1; border-radius: 5px; border: none; }
        .btn-photo { background: #e0e0e0; color: #333; font-weight: bold; flex: 1; border-radius: 5px; border: none; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; }
        .btn-complete { background: #d35400; color: white; font-weight: bold; flex: 2; border-radius: 5px; border: none; font-size: 1.1rem; }

        /* 画面切り替え制御 */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* 読み込み中ローダー */
        .loading-spinner { text-align: center; padding: 50px; color: #0056b3; }
    </style>
</head>
<body>

    <div class="app-header d-flex justify-content-between align-items-center">
        <div class="company-name">
            <i class="fas fa-building"></i> 
            <span id="header-company">読み込み中...</span>
        </div>
        <div class="text-end">
            <div id="header-date" style="font-size:1.2rem; font-weight:bold;">...</div>
            <div id="header-name" style="font-weight:bold;">...</div>
        </div>
    </div>
    <div class="greeting-bar">本日もご安全に！</div>

    <div id="screen-list" class="screen active">
        <div class="container mt-3">
            <h5 class="fw-bold text-primary border-bottom border-primary pb-2 mb-3">本日の予定</h5>
            
            <div id="job-list-container">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin fa-2x"></i><br>データ取得中...
                </div>
            </div>
        </div>

        <div class="fixed-bottom bg-white border-top py-2 d-flex justify-content-around">
            <div class="text-center text-primary"><i class="fas fa-calendar-check fa-lg"></i><br><small>今日の稼働</small></div>
            <div class="text-center text-muted"><i class="fas fa-bell fa-lg"></i><br><small>お知らせ</small></div>
            <div class="text-center text-muted"><i class="fas fa-ellipsis-h fa-lg"></i><br><small>その他</small></div>
        </div>
    </div>

    <div id="screen-detail" class="screen">
        <div class="container mt-3 px-2">
            <div class="detail-row">
                <div class="info-box box-time">
                    <div class="info-label">時 間</div>
                    <div class="info-value" id="detail-time">-</div>
                </div>
                <div class="info-box box-type">
                    <div class="info-label">区 分</div>
                    <div class="info-value" id="detail-type">-</div>
                </div>
                <div class="info-box box-car">
                    <div class="info-label">車 輛</div>
                    <div class="info-value" id="detail-car">-</div>
                </div>
            </div>

            <div class="info-box">
                <div class="info-label">得 意 先</div>
                <div class="info-value" id="detail-client">-</div>
            </div>

            <div class="info-box">
                <div class="info-label">現 場 名</div>
                <div class="info-value" id="detail-location">-</div>
            </div>

            <div class="info-box">
                <div class="info-label">作 業 内 容</div>
                <div class="info-value" id="detail-work">-</div>
            </div>

            <div class="info-box box-contact">
                <div class="info-label">連 絡 先</div>
                <div class="info-value" id="detail-contact">-</div>
            </div>

            <div class="info-box box-notes mb-3">
                <div class="info-label">連 絡 事 項</div>
                <div class="note-text" id="detail-notes">なし</div>
            </div>

            <div class="btn-action-row px-2">
                <button class="btn-map" onclick="openMap()">
                    <i class="fas fa-map-marker-alt text-danger fa-lg"></i> 現場地図
                </button>
                <button class="btn-files" onclick="openFiles()">
                    <i class="fas fa-paperclip fa-lg"></i> 資料を見る
                </button>
            </div>
            
            <div style="height: 80px;"></div> 
        </div>

        <div class="footer-actions">
            <button class="btn-back" onclick="goBack()">戻る</button>
            <button class="btn-photo">
                <i class="fas fa-camera"></i><small>写真/メモ</small>
            </button>
            <button class="btn-complete" onclick="completeWork()">作業完了通知</button>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentJobs = [];
        let selectedJob = null;

        // --- 初期化 & データ取得 ---
        (async () => {
            // 日付表示
            const now = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            document.getElementById('header-date').textContent = `${now.getMonth()+1}月${now.getDate()}日(${days[now.getDay()]})`;

            // APIからデータ取得
            try {
                const response = await fetch('/api/show-env');
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                
                // ★追加: 部署名の表示
                if (data.businessUnitName) {
                    document.getElementById('header-company').textContent = data.businessUnitName;
                } else {
                    document.getElementById('header-company').textContent = "所属なし";
                }

                // ユーザー名セット
                if (data.userName) {
                    document.getElementById('header-name').textContent = data.userName + " 様";
                }

                // リスト描画
                currentJobs = data.results || [];
                renderList(currentJobs);

            } catch (e) {
                console.error(e);
                document.getElementById('job-list-container').innerHTML = `<div class="text-danger text-center p-3">データの取得に失敗しました。<br>${e.message}</div>`;
            }
        })();

        // --- リスト描画 ---
        function renderList(jobs) {
            const container = document.getElementById('job-list-container');
            container.innerHTML = ''; // クリア

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">本日の予定はありません</div>';
                return;
            }

            jobs.forEach((job, index) => {
                const card = document.createElement('div');
                card.className = 'today-card';
                card.onclick = () => showDetail(index);

                let statusBadge = `<button class="btn btn-outline-primary btn-sm fw-bold">${job.status}</button>`;
                
                card.innerHTML = `
                    <div class="today-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="time-badge">${job.time} ～</span>
                                <span class="tag-badge">${job.type}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="fw-bold fs-5 mb-1">${job.client}</div>
                        <div class="fw-bold text-primary mb-2">${job.location}</div>
                        <div class="text-muted small">${job.workContent}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 詳細画面表示 ---
        function showDetail(index) {
            selectedJob = currentJobs[index];
            if (!selectedJob) return;

            document.getElementById('detail-time').textContent = selectedJob.time;
            document.getElementById('detail-type').textContent = selectedJob.type;
            document.getElementById('detail-car').textContent = selectedJob.car;
            document.getElementById('detail-client').textContent = selectedJob.client;
            document.getElementById('detail-location').textContent = selectedJob.location;
            document.getElementById('detail-work').textContent = selectedJob.workContent;
            document.getElementById('detail-contact').textContent = selectedJob.contact;
            document.getElementById('detail-notes').textContent = selectedJob.notes || "なし";

            document.getElementById('screen-list').classList.remove('active');
            document.getElementById('screen-detail').classList.add('active');
            window.scrollTo(0, 0);
        }

        function goBack() {
            document.getElementById('screen-detail').classList.remove('active');
            document.getElementById('screen-list').classList.add('active');
        }

        // --- アクションボタン (実装予定) ---
        function openMap() {
            const query = selectedJob.location || "";
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        }

        function openFiles() {
            alert('添付ファイル機能は後ほど実装します');
        }

        function completeWork() {
            if(confirm('作業完了通知を送りますか？')) {
                alert('送信しました(デモ)');
                goBack();
            }
        }
    </script>
</body>
</html>
