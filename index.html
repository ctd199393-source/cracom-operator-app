<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オペレーター指示書アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: "Helvetica Neue", Arial, sans-serif; padding-bottom: 100px; }
        
        /* 画面切り替え制御 (ここを修正) */
        .view-section { display: none !important; height: 100vh; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .view-section.active { display: flex !important; }
        
        #app-content { display: none; }
        #app-content.active { display: block; }

        /* アプリ内の画面切り替え */
        .screen { display: none !important; }
        .screen.active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ウェルカム画面 */
        .welcome-logo { color: #cf2e2e; font-size: 3rem; margin-bottom: 20px; }
        .btn-login-start { background-color: #0056b3; color: white; padding: 15px 40px; font-size: 1.2rem; border-radius: 30px; font-weight: bold; text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* アプリヘッダー */
        .app-header { background-color: #fff; border-bottom: 3px solid #cf2e2e; padding: 10px 15px; position: sticky; top: 0; z-index: 1000; }
        .greeting-bar { background-color: #fff; text-align: center; color: #0056b3; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #ddd; font-size: 1.2rem; }

        /* リスト画面カード */
        .today-card { border: 2px solid #0056b3; background: white; border-radius: 5px; margin: 15px; padding: 15px; cursor: pointer; transition: transform 0.1s; }
        .today-card:active { transform: scale(0.98); background-color: #f8f9fa; }
        .time-badge { font-size: 1.3rem; font-weight: bold; }
        .tag-badge { border: 1px solid #0056b3; color: #0056b3; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        
        /* 詳細画面 */
        .info-box { background: #fff; border: 2px solid #0056b3; border-radius: 5px; padding: 5px 10px; width: 100%; margin-bottom: 8px; }
        .info-label { color: #0056b3; font-size: 0.8rem; font-weight: bold; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: #333; white-space: pre-wrap; }
        .detail-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .box-time { flex: 2; text-align: center; } .box-type { flex: 1; text-align: center; } .box-car { flex: 2; text-align: right; }
        .box-contact { border-color: #8B4513; color: #8B4513; } .box-contact .info-label { color: #8B4513; }
        .box-notes { border-color: #0056b3; min-height: 100px; }

        /* ボタン類 */
        .btn-action-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-map { background: #e0e0e0; border: none; color: #333; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 12px; border-radius: 5px; }
        .btn-files { background: #e0e0e0; border: none; color: #0056b3; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 12px; border-radius: 5px; }
        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ccc; z-index: 2000; }
        .btn-back { background: #0056b3; color: white; flex: 1; border:none; border-radius:5px; font-weight:bold; }
        .btn-photo { background: #e0e0e0; color: #333; flex: 1; border:none; border-radius:5px; font-size:0.8rem; }
        .btn-complete { background: #d35400; color: white; flex: 2; border:none; border-radius:5px; font-size:1.1rem; font-weight:bold; }

        .loading-spinner { text-align: center; padding: 50px; color: #0056b3; }
    </style>
</head>
<body>

    <div id="view-welcome" class="view-section">
        <div class="welcome-logo"><i class="fas fa-truck-moving"></i></div>
        <h2 class="fw-bold mb-4">オペレーターアプリ</h2>
        <p class="text-muted mb-4">業務を開始するには<br>ログインしてください</p>
        <a href="/.auth/login/aad" class="btn-login-start">
            <i class="fab fa-microsoft me-2"></i> ログイン
        </a>
    </div>

    <div id="view-checking" class="view-section">
        <div class="mb-3"><i class="fas fa-circle-notch fa-spin fa-3x text-primary"></i></div>
        <h4 class="fw-bold text-secondary">認証情報を確認中...</h4>
    </div>

    <div id="view-error" class="view-section">
        <div class="mb-3 text-danger"><i class="fas fa-exclamation-circle fa-4x"></i></div>
        <h4 class="fw-bold">利用が許可されていません</h4>
        <p class="text-muted px-4" id="error-msg-detail">...</p>
        <a href="/.auth/logout" class="btn btn-outline-secondary mt-3">ログアウト</a>
    </div>

    <div id="app-content">
        <div class="app-header d-flex justify-content-between align-items-center">
            <div class="fw-bold"><i class="fas fa-building"></i> <span id="header-company">読み込み中...</span></div>
            <div class="text-end fw-bold">
                <div id="header-date">...</div>
                <div id="header-name">...</div>
            </div>
        </div>
        <div class="greeting-bar">本日もご安全に！</div>

        <div id="screen-list" class="screen active">
            <div class="container mt-3">
                <h5 class="fw-bold text-primary border-bottom border-primary pb-2 mb-3">本日の予定</h5>
                <div id="job-list-container">
