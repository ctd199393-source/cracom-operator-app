<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オペレーター指示書アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: "Helvetica Neue", Arial, sans-serif; padding-bottom: 100px; }
        
        /* 画面切り替え制御 */
        .view-section { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #view-checking { display: flex; } /* 初期表示 */
        #app-content { display: none; }
        
        .welcome-logo { color: #cf2e2e; font-size: 3rem; margin-bottom: 20px; }
        .btn-login-start { background-color: #0056b3; color: white; padding: 15px 40px; font-size: 1.2rem; border-radius: 30px; font-weight: bold; text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-login-start:hover { background-color: #004494; color: white; }
        
        /* アプリ共通 */
        .app-header { background-color: #fff; border-bottom: 3px solid #cf2e2e; padding: 10px 15px; position: sticky; top: 0; z-index: 1000; }
        .greeting-bar { background-color: #fff; text-align: center; color: #0056b3; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #ddd; font-size: 1.2rem; }
        .today-card { border: 2px solid #0056b3; background: white; border-radius: 5px; margin: 15px; padding: 15px; cursor: pointer; }
        .time-badge { font-size: 1.3rem; font-weight: bold; }
        .tag-badge { border: 1px solid #0056b3; color: #0056b3; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .info-box { background: #fff; border: 2px solid #0056b3; border-radius: 5px; padding: 5px 10px; width: 100%; margin-bottom: 8px; }
        .info-label { color: #0056b3; font-size: 0.8rem; font-weight: bold; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: #333; white-space: pre-wrap; }
        .detail-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .box-time { flex: 2; text-align: center; } .box-type { flex: 1; text-align: center; } .box-car { flex: 2; text-align: right; }
        .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); padding: 10px; display: flex; gap: 10px; border-top: 1px solid #ccc; z-index: 2000; }
        .btn-back { background: #0056b3; color: white; flex: 1; border:none; border-radius:5px; font-weight:bold; }
        .btn-photo { background: #e0e0e0; color: #333; flex: 1; border:none; border-radius:5px; font-size:0.8rem; }
        .btn-complete { background: #d35400; color: white; flex: 2; border:none; border-radius:5px; font-size:1.1rem; font-weight:bold; }
        .loading-spinner { text-align: center; padding: 50px; color: #0056b3; }
        #debug-error { display:none; position:fixed; bottom:0; left:0; width:100%; background:red; color:white; padding:10px; z-index:9999; font-size:12px; }
    </style>
</head>
<body>
    <div id="debug-error"></div>

    <div id="view-welcome" class="view-section">
        <div class="welcome-logo"><i class="fas fa-truck-moving"></i></div>
        <h2 class="fw-bold mb-4">オペレーターアプリ</h2>
        <p class="text-muted mb-4">業務を開始するには<br>ログインしてください</p>
        
        <a href="https://login.microsoftonline.com/41456790-9a33-42f0-a473-260d54e8d1b6/oauth2/v2.0/authorize?client_id=3f113cb1-9657-47c4-8de1-3f3744e0dcb9&response_type=id_token&redirect_uri=https%3A%2F%2Fmango-mushroom-026570700.3.azurestaticapps.net%2F.auth%2Flogin%2Faad%2Fcallback&scope=openid+profile+email&response_mode=form_post&nonce=12345" class="btn-login-start">
            <i class="fab fa-microsoft me-2"></i> ログイン
        </a>
    </div>

    <div id="view-checking" class="view-section">
        <div class="mb-3"><i class="fas fa-circle-notch fa-spin fa-3x text-primary"></i></div>
        <h4 class="fw-bold text-secondary">読み込み中...</h4>
        <p class="text-muted" id="checking-text">認証情報を確認しています</p>
    </div>

    <div id="view-error" class="view-section">
        <div class="mb-3 text-danger"><i class="fas fa-exclamation-circle fa-4x"></i></div>
        <h4 class="fw-bold">利用が許可されていません</h4>
        <p class="text-muted px-4" id="error-msg-detail">...</p>
        <a href="/.auth/logout" class="btn btn-outline-secondary mt-3">ログアウト</a>
    </div>

    <div id="app-content">
        <div class="app-header d-flex justify-content-between align-items-center">
            <div class="fw-bold"><i class="fas fa-building"></i> <span id="header-company">読み込み中...</span></div>
            <div class="text-end fw-bold">
                <div id="header-date">...</div>
                <div id="header-name">...</div>
            </div>
        </div>
        <div class="greeting-bar">本日もご安全に！</div>

        <div id="screen-list" style="display:block">
            <div class="container mt-3">
                <h5 class="fw-bold text-primary border-bottom border-primary pb-2 mb-3">本日の予定</h5>
                <div id="job-list-container">
                    <div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i><br>データ取得中...</div>
                </div>
            </div>
            <div class="fixed-bottom bg-white border-top py-2 d-flex justify-content-around">
                <div class="text-center text-primary"><i class="fas fa-calendar-check fa-lg"></i><br><small>今日の稼働</small></div>
                <div class="text-center text-muted"><i class="fas fa-bell fa-lg"></i><br><small>お知らせ</small></div>
                <div class="text-center text-muted"><i class="fas fa-ellipsis-h fa-lg"></i><br><small>その他</small></div>
            </div>
        </div>

        <div id="screen-detail" style="display:none">
            <div class="container mt-3 px-2">
                <div class="detail-row">
                    <div class="info-box box-time"><div class="info-label">時間</div><div class="info-value" id="detail-time"></div></div>
                    <div class="info-box box-type"><div class="info-label">区分</div><div class="info-value" id="detail-type"></div></div>
                    <div class="info-box box-car"><div class="info-label">車 輛</div><div class="info-value" id="detail-car"></div></div>
                </div>
                <div class="info-box"><div class="info-label">得意先</div><div class="info-value" id="detail-client"></div></div>
                <div class="info-box"><div class="info-label">現場名</div><div class="info-value" id="detail-location"></div></div>
                <div class="info-box"><div class="info-label">作業内容</div><div class="info-value" id="detail-work"></div></div>
                <div class="info-box" style="border-color:#8B4513;color:#8B4513"><div class="info-label">連絡先</div><div class="info-value" id="detail-contact"></div></div>
                <div class="info-box mb-5"><div class="info-label">連絡事項</div><div class="info-value" id="detail-notes"></div></div>
                <div style="height: 80px;"></div> 
            </div>
            <div class="footer-actions">
                <button class="btn-back" onclick="goBack()">戻る</button>
                <button class="btn-photo"><i class="fas fa-camera"></i></button>
                <button class="btn-complete" onclick="completeWork()">作業完了通知</button>
            </div>
        </div>
    </div>

    <script>
        window.onerror = function(msg,url,line){ document.getElementById('debug-error').style.display='block'; document.getElementById('debug-error').textContent=`Error:${msg} (${line})`; };

        let currentJobs = [];
        let selectedJob = null;

        function showSection(id) {
            document.querySelectorAll('.view-section, #app-content').forEach(el => {
                el.style.display = 'none';
            });
            const target = document.getElementById(id);
            if(id === 'app-content') target.style.display = 'block';
            else target.style.display = 'flex';
        }

        // メイン処理
        (async () => {
            try {
                const authRes = await fetch('/.auth/me');
                const authData = await authRes.json();
                
                if (!authData.clientPrincipal) {
                    showSection('view-welcome');
                    return;
                }
                
                // ログイン済み
                const res = await fetch('/api/show-env');
                if (!res.ok) {
                    const err = await res.json().catch(()=>({}));
                    if (res.status === 403) {
                        document.getElementById('error-msg-detail').innerHTML = "作業員マスタに登録がありません。<br>管理者に連絡してください。";
                    } else {
                        document.getElementById('error-msg-detail').textContent = `システムエラー: ${err.details || res.status}`;
                    }
                    showSection('view-error');
                    return;
                }
                
                const data = await res.json();
                setupApp(data);
                showSection('app-content');

            } catch (e) {
                document.getElementById('error-msg-detail').textContent = `通信エラー: ${e.message}`;
                showSection('view-error');
            }
        })();

        function setupApp(data) {
            const now = new Date();
            document.getElementById('header-date').textContent = `${now.getMonth()+1}月${now.getDate()}日`;
            if(data.businessUnitName) document.getElementById('header-company').textContent = data.businessUnitName;
            if(data.userName) document.getElementById('header-name').textContent = data.userName + " 様";
            currentJobs = data.results || [];
            renderList(currentJobs);
        }

        function renderList(jobs) {
            const container = document.getElementById('job-list-container');
            container.innerHTML = '';
            if(jobs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">予定はありません</div>';
                return;
            }
            jobs.forEach((job, i) => {
                const div = document.createElement('div');
                div.className = 'today-card';
                div.onclick = () => showDetail(i);
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><span class="time-badge">${job.time} ～</span><span class="tag-badge">${job.type}</span></div>
                        <button class="btn btn-outline-primary btn-sm fw-bold">${job.status}</button>
                    </div>
                    <div class="fw-bold fs-5">${job.client}</div>
                    <div class="fw-bold text-primary">${job.location}</div>
                    <div class="text-muted small">${job.workContent}</div>`;
                container.appendChild(div);
            });
        }

        function showDetail(i) {
            selectedJob = currentJobs[i];
            if (!selectedJob) return;
            document.getElementById('detail-time').textContent = selectedJob.time;
            document.getElementById('detail-type').textContent = selectedJob.type;
            document.getElementById('detail-car').textContent = selectedJob.car;
            document.getElementById('detail-client').textContent = selectedJob.client;
            document.getElementById('detail-location').textContent = selectedJob.location;
            document.getElementById('detail-work').textContent = selectedJob.workContent;
            document.getElementById('detail-contact').textContent = selectedJob.contact;
            document.getElementById('detail-notes').textContent = selectedJob.notes || "なし";
            document.getElementById('screen-list').style.display = 'none';
            document.getElementById('screen-detail').style.display = 'block';
            window.scrollTo(0,0);
        }

        function goBack() {
            document.getElementById('screen-detail').style.display = 'none';
            document.getElementById('screen-list').style.display = 'block';
        }
        function openMap() {
            const query = selectedJob.location || "";
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        }
        function openFiles() { alert('添付ファイル機能は後ほど実装します'); }
        function completeWork() { if(confirm('送信しますか？')) { alert('完了'); goBack(); } }
    </script>
</body>
</html>
