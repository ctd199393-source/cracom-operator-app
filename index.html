<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オペレーター指示書アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .view-section { display: none; padding: 20px; }
        .btn-login-start {
            display: inline-block; padding: 15px 30px; background-color: #0078d4;
            color: white; text-decoration: none; border-radius: 8px; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;
        }
        .btn-login-start:hover { background-color: #005a9e; transform: translateY(-2px); }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-label { font-size: 0.85rem; color: #6c757d; width: 80px; display: inline-block; }
    </style>
</head>
<body>

    <div id="view-welcome" class="view-section text-center mt-5">
        <h2 class="fw-bold mb-4">オペレーターアプリ</h2>
        <p class="text-muted mb-4">アカウントをお持ちでない方も、<br>以下のボタンから登録へ進めます。</p>
        <a href="/.auth/login/aad?post_login_redirect_uri=/" class="btn-login-start">
            <i class="fas fa-sign-in-alt me-2"></i> ログイン / 新規登録
        </a>
    </div>

    <div id="view-loading" class="view-section text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">データを照合中...</p>
    </div>

    <div id="view-error" class="view-section text-center mt-5">
        <div class="alert alert-danger d-inline-block text-start">
            <h5 class="alert-heading"><i class="fas fa-exclamation-circle"></i> 利用権限がありません</h5>
            <hr>
            <p id="error-message">マスタに登録されていません。</p>
        </div>
        <div class="mt-3">
            <a href="/.auth/logout" class="btn btn-outline-secondary btn-sm">ログアウト</a>
        </div>
    </div>

    <div id="view-app" class="view-section container" style="max-width: 800px;">
        <div class="d-flex justify-content-between align-items-center mb-4 pt-3">
            <h4 class="fw-bold"><i class="fas fa-truck-pickup me-2"></i>配車指示書</h4>
            <div class="text-end">
                <small id="user-display-name" class="d-block text-muted" style="font-size:0.8rem;"></small>
                <a href="/.auth/logout" class="text-danger small" style="text-decoration:none;">ログアウト</a>
            </div>
        </div>
        
        <div id="data-container">
            </div>
    </div>

    <script>
        function showSection(id) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        // 日付整形用のヘルパー関数 (例: 2025-12-01T00:00:00Z -> 2025/12/01)
        function formatDate(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleDateString('ja-JP'); 
        }

        // 時間整形用のヘルパー関数 (例: 2025-12-01T08:30:00Z -> 08:30)
        function formatTime(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }

        (async () => {
            try {
                // 1. 認証確認
                const authRes = await fetch('/.auth/me');
                const authData = await authRes.json();
                
                if (!authData.clientPrincipal) {
                    showSection('view-welcome');
                    return;
                }

                showSection('view-loading');
                
                // 2. API呼び出し
                const apiRes = await fetch('/api/show-env');
                
                if (!apiRes.ok) {
                    const errBody = await apiRes.json();
                    document.getElementById('error-message').textContent = 
                        errBody.error || "データ取得エラーが発生しました。";
                    showSection('view-error');
                    return;
                }

                const data = await apiRes.json();
                
                // ユーザー名表示 (Dataverseのマスタ名を使用)
                const userName = data.user ? data.user.name : authData.clientPrincipal.userDetails;
                document.getElementById('user-display-name').textContent = userName;

                // 3. データ描画
                const container = document.getElementById('data-container');
                
                if (data.records && data.records.length > 0) {
                    let html = '';
                    data.records.forEach(rec => {
                        // ★修正ポイント: 列名をDataverseに合わせて正しくマッピング
                        // new_genbamei (現場名), new_day (日付), new_start_time (開始時間), new_sagyou_naiyou (作業内容)
                        
                        html += `
                        <div class="card card-custom p-4">
                            <h5 class="card-title text-primary fw-bold mb-3">
                                ${rec.new_genbamei || '現場名未定'}
                            </h5>
                            <div class="mb-2">
                                <span class="card-label"><strong><i class="far fa-calendar-alt"></i> 日付:</strong></span>
                                <span>${formatDate(rec.new_day)}</span>
                            </div>
                            <div class="mb-2">
                                <span class="card-label"><strong><i class="far fa-clock"></i> 時間:</strong></span>
                                <span>${formatTime(rec.new_start_time)}</span>
                            </div>
                            <div class="mb-2">
                                <span class="card-label"><strong><i class="fas fa-tasks"></i> 内容:</strong></span>
                                <span>${rec.new_sagyou_naiyou || '-'}</span>
                            </div>
                        </div>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-info">現在、担当する配車データはありません。</div>';
                }

                showSection('view-app');

            } catch (e) {
                console.error(e);
                document.getElementById('error-message').textContent = "アプリケーションエラーが発生しました。";
                showSection('view-error');
            }
        })();
    </script>
</body>
</html>
